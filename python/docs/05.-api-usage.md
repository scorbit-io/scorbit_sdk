# API Usage / Entry

### Environments

* Staging: https://scorbit-api-staging.herokuapp.com/api/
* Production: https://api.scorbit.io/api/

### Authentication and Provisioning:

1. Use steps provided in the [\[02.-Authentication-and-Provisioning\] ](02.-authentication.md)page.
2. Get the stoken back in response and use as illustrated below.

### Websockets

The Scorbit API prefers a websocket connection when possible, and falls back to traditional REST API requests when this is not available. We recommend building your logic to accommodate websockets if possible, using the method described in [06. Websocket Connections](06.-Websocket-Connections).

### Score Entry API

Every authenticated call to the API will need to have a header with the stoken in it.

The format of the header is `Authorization: SToken abc123`

Scores are created and updated by posting data to a single endpoint: `https://api.scorbit.io/api/entry/`

As a general practice, if you are not using websockets, _**you must wait for a response from the API before sending your next package.**_

### Cache Bypass

All POST requests must include proper cache bypass control in the header. Using curl, this is done by adding:

```
-H 'Cache-Control: no-cache'
```

to outbound curl requests along side other Authorization, and Content-Type headers. For implementations other than curl, **set a ‘Cache-Control’ header with a value of ‘no-cache’**.

### Code Sample

```
import requests
data = {
    'session_uuid': '01234ABCDEF',
    'session_sequence': 1,
    'session_time': 12345678,
    'active': true,
    'current_p1_score': 6000,
    'current_ball': 3,
    'current_player': 1,
}
    
response = requests.post("https://api.scorbit.io/api/entry/", data=data, headers={'Authorization': 'SToken abc123'})
```

### Update Frequency

In general, the Scorbit API is happy to receive any updates as frequently as the machine can send them. We prefer the use of websockets to reduce latency, as discussed in the section [06. Websocket Connections](06.-websocket-connections.md).

However, it is important to immediately begin sending score updates, even when the score is at 0 points, when the player hits start. For example, if the player hits start and the ball sits in the shooter lane, updates with 0 points should begin with increasing sequence numbers. This way the API can respond and the various apps and visualizations recognize a game has begun.

As a general rule, Scorbit likes to receive updates with a minimum update frequency of 2 seconds, though we recommend 1 second or faster when changes occur.

### Score POST fields

The following fields are expected on POST data to the `/api/entry/` endpoint:

* Required fields:
  * `session_uuid`: A unique UUID4 string generated for the game session.
  * `session_sequence`: A counter starting at 0 for the first update of a game and increasing by one each subsequent update.
  * `session_time`: Time in milliseconds since the start of the gaming session.
  * `active`: Boolean indicating whether or not the gaming session is currently active. Sending `false` closes a session.
* Optional fields:
  * `current_player`: Integer number for the current player, start at 1. (optional)
  * `current_ball`: Integer ball number for the current player, starting at 1. (optional)
  * `current_p1_score`: Integer value for player #1 score. (optional)
  * `current_p2_score`: Integer value for player #2 score. (optional)
  * `current_p3_score`: Integer value for player #3 score. (optional)
  * `current_p4_score`: Integer value for player #4 score. (optional)
  * `current_p5_score`: Integer value for player #5 score. (optional)
  * `current_p6_score`: Integer value for player #6 score. (optional)
  * `game_modes`: String value containing currently active game modes (optional)

**For each score values, sending a value of `-1` indicates that this player does not exist. Sending `-1` allows for game reset, so if a game is started and then a player drops out and the game is reset, sending a `-1` will remove that player.**

Currently, 6 is the maximum number of players allowed in a single game session.

#### Example entry POST data

**Start a new session with no scores reported yet.**

```
{
    "session_uuid": "01234567-890a-bcde-f012-3456789abcde",
    "session_sequence": 0,
    "session_time": 1,
    "active": true,
}
```

**Send an update mid-game with 3 players. (See section** [**08. Game Modes**](08.-Game-Modes) **for more details on Game Mode syntax.)**

```
{
    "session_uuid": "01234567-890a-bcde-f012-3456789abcde",
    "session_sequence": 12,
    "session_time": 120000,
    "active": true,
    "current_ball": 2,
    "current_player": 3,
    "current_p1_score": 7000,
    "current_p2_score": 8000,
    "current_p3_score": 9000,
    "game_modes": "NA:King Tut x2 bonus;NA:Mr. Freeze timers",
}
```

_(More information about adding modes can be found in section_ [_08. Game Modes_](08.-Game-Modes)_.)_

**End the game with final scores.**

```
{
    "session_uuid": "01234567-890a-bcde-f012-3456789abcde",
    "session_sequence": 12,
    "session_time": 456000,
    "active": false,
    "current_p1_score": 12000,
    "current_p2_score": 13000,
    "current_p3_score": 14000,
}
```

### Completing a Session:

A game session will be closed when any of these events occur:

1. A /entry/ update is received `active` set to `false`. Be sure to include all the final scores when ending the session if they have changed since the last update. This is normal (successful) close. You should always do this.
2. /heartbeat/ receives an update setting `session_active=false`. You should always do this.
3. A score update from a new session is received, indicated by a different `session_uuid` value. In this case the previous open session will be automatically closed as unsuccessful.
4. An application version is received from the scorbitron (/installed/). If there was open session in the API it will be automatically closed as unsuccessful. Application version has to be sent only once on the application start. This will help to close previous open session if there was power cycle during mid-session.
5. The session was not closed and there is no API activitiy from device (for example regular heartbeat is the activity). The API will close any open session automatically after 5 minutes timeout assuming the game is powered off.

### Local Session Log and Game Timeline

During a session all events (score update, current player change, current ball change, game modes change) must be recorded locally and should be uploaded at the end of the session in the form of a .csv file. The frequency of updates to this file can be more frequent than what is communicated to the API if necessary, or include information specific to the session or game code not included in the API POSTs for various reasons.

An endpoint is used to upload this complete game session log, which is saved in AWS S3 and tied to the session object in the database. This file is then pulled when a user wishes to review the game session information.

This endpoint is located at: `/api/session_log/`

It accepts two required parameters using `POST Multipart` format:

* `uuid`: The UUID of the session this game log is for.
* `log_file`: The file to be stored in S3 as the session log

#### Example session log file in CSV format:

8227ecd8-701a-4672-84b9-a67a5a4bcb2b.csv

```csv
time,p1,p2,p3,p4,p5,p6,player,ball,game_modes
1601278494,0,,,,,,1,1,
1601278496,1000,,,,,,1,1,
1601278496,2000,,,,,,1,1,
1601278496,3000,,,,,,1,1,
1601278496,4000,,,,,,1,1,
1601278496,6000,,,,,,1,1,
1601278496,7000,,,,,,1,1,
1601278496,8000,,,,,,1,1,
1601278496,9000,,,,,,1,1,"MB:Multiball"
1601278496,10000,,,,,,1,1,"MB:Multiball"
1601278496,11000,,,,,,1,1,"MB:Multiball"
1601278496,12000,,,,,,1,1,"MB:Multiball"
1601278496,13000,,,,,,1,1,"MB:Multiball;BL:Ball Locked"
1601278497,13100,,,,,,1,1,"MB:Multiball;BL:Ball Locked"
1601278497,13200,,,,,,1,1,"MB:Multiball;BL:Ball Locked"
1601278497,13300,,,,,,1,1,
1601278497,13400,,,,,,1,1,
1601278497,13500,,,,,,1,2,
1601278497,14700,,,,,,1,2,
1601278497,15900,,,,,,1,3,
1601278497,17100,,,,,,1,3,
1601278497,18300,,,,,,1,3,
```
