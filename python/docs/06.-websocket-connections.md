# Websocket Connections

Scorbit makes use of websockets where available. These provide a significant reduction of overhead on the machine's network stack, as well as decrease perceived latencies by the users when viewing live games in the app or ScorbitVision. It can also reduce the latencies for announcing achievements when a machine displays these on the screen of the game.

## Websocket Authentication

In order to connect over websockets you must first request a stoken from the REST API using the method outlined in [02. Authentication](02.-Authentication). Once you have the stoken, you can make a request for a websocket token using the `/api/auth/ws` endpoint. _**Note that these websocket tokens expire in 10 seconds.**_

### GET https://api.scorbit.io/api/auth/ws/

Response is in JSON format:

`{
  "token": "gAAAAABhSRQn9VDMjfM0vGMSfX_..."
}`

### wss://api.scorbit.io/ws/?token=[access token]

Upon successful connection you will receive a message of

`{"message": "CONNECTED"}`

## Required Keep-Alive

In order for the websocket connection to remain open it is recommended that you periodically send a HEARTBEAT message at a minimum of every two seconds.

## Scorbitron Supported Commands

* HEARTBEAT
* ENTRY

Using the same JSON format referred to in [05. API Usage](05.-API-Usage) POST commands, you may send the formatted data over the WSS connection.

Examples:

* Heartbeat Request:
 `JSON.stringify({"message": {"cmd": "HEARTBEAT", "data": {}}})`

* Heartbeat Response:
 `{"result": true, "data": {"venuemachine_id": 18, "machine_id": 1}, "cmd": "HEARTBEAT"}`

The response should contain the command result True/False and the "cmd" being responded to as they can be received in any order.

* Entry Request:
 `JSON.stringify({"message": {"cmd": "ENTRY",
    		"data": {
    			"active": true,
    			"session_uuid": "51927400-161d-48e4-aa02-b9b74f75bbcb",
    			"session_sequence": 723,
    			"session_time": 121191,
    			"current_p1_score": 16548512
    		}
    	}
    })`

* Entry Response:
 `{"result": true, "data": {"scores": [{"position": 1, "player": {"id": 1, "cached_display_name": "chris", "profile_picture": null}}]}, "cmd": "ENTRY"}`

## Asynchronous Messages

Sometimes you can expect to receive background messages such as balance updates or direct communication with a Scorbitron or user.
One example would be a "coin drop" command after a payment and/or credit is processed. Which is a bit different then sending commands and waiting for responses.

`{"cmd": "COIN_DROP", "amount": 1}`

## Error Messages

Error messages will be in the form of `"result": false`

Examples:

* Forgetting to send a command
`{"message": {"error": "Missing command"}`

* Sending a restricted command (Scorbitrons and Users are allowed to send different commands)
`{"message": {"error": "Forbidden"}`

* Something has gone wrong
`{"message": {"error": "Bad result"}`