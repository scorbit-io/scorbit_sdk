# Challenges

Challenges are a simple and effective way to encourage repeat engagement with other Scorbit users, asynchronously. There are two types of challenges: Challenges and Challenge Matches. Challenge Matches are not released at this time.

## Challenges (Open Challenges)

Challenges (or "Open Challenges), are casual and designed to be a form of sharing and gentle competitive nudging another player to try to beat a score. Within the app, Challenges are referred to as "tag a user to beat your score," because it does have some analogies to sharing, but with an interactive twist.

When a user completes a game, or visits a recently completed score, they can choose other users to tag to beat the score. Those targeted users will each have a new corresponding challengeId representing the challenge. These challengeIds pass through three stages: Invite, In-Progress, and Complete.

During the Invite (open) stage, the targeted user (challenger) receives a notification announcing that someone (the creator) has challenged them. They can accept or ignore the challenge. Every challenge has a set number of days (currently 7) to be accepted and completed. The challenger can accept the creator's challenge any time within the expiry period.

During the In Progress stage, the challenger can make as many attempts to beat the score as they desire, until the expiration date.

Once the challenge expires or the score has been beat, the challenge moves to the Complete stage.

Any completed challenge appears in both the creator and challenger's Challenge menu, Community Feed, as well as Profile Challenges tab. Notifications are sent when challenges are created and when they are completed with a winner. In the Scorbit app, attempts are only displayed to the challenger as they complete each failed attempt, though this is up to the specific UI design.

## Challenge Data Models

Any challenge is publicly accessible and comprised of three sections: The challenge, challenge invites, and challenge scores. You can query any challenge with:

`GET <api_url>/challenge/{challengeId}`

## ChallengeID Model

| | Description |
| :--- | :--- |
| creator | FK to user who created the challenge |
| description | Char field, max length 256. |
| machine | FK to machineID associated with the challenge. |
| venuemachine | FK to the venuemachine on which the creator scored the challenge |
| is_archived | Defaults to False and can be "archived" by the creator, and rendered invisible. |
| is_public | Whether or not this is publically viewable and joinable. This is currently only an internal flag. |
| is_pro | True for Pro challenges, only Scorbitron scores are accepted. This is designed for future use, not current challenges. |
| is_premeditated [deprecated] | Will be used later for Challenge Match. True if created before the creator plays their game, and the creator also only gets one shot. |
| is_venuemachine_specific [deprecated] | Will be used to enforce that challenge_scores are played on the same physical machine. True if this must be played on a specific cabinet. |
| are_invites_settled | Defaults to false and Auto-updated to True when all invites are settled (Complete, Rejected, or DNF). Note that a challengeID is only settled when it expires or if the challenger wins (gets a score greater than the creator score prior to expiration). |
| scores | Many-to-Many through the ChallengeScore table to link scores. Note that a scoreID can be used on multiple challenges. This many-to-many functionality has future use with Challenge Matches only, not Challenges. |
| invites | Many-to-Many through the ChallengeInvite table to link invites. There should be only one invite per ChallengeID, so this may change from being a separate table. |
| attempts | How many times the challenger has attempted to beat the original users score. Increments by one each time a new Challenge_Score is submitted. |
| created_at | Date/time of challenge creation. |
| updated_at | Date/ time of any changes made to the object. |

## ChallengeScore Model

| | Description |
| :--- | :--- |
| challenge | FK to challenge. |
| user | FK to user responsible for the submitted score. |
| score | FK to score. |
| status | {IN_PROGRESS, COMPLETE, DNF} (auto-updated by score pipeline) |
| created_at | Datetime of object creation. |

## ChallengeInvite Model

| | Description |
| :--- | :--- |
| challenge | FK to challenge. |
| user | FK to user invited. |
| challenge_score | FK to ChallengeScore object. |
| status |  {OPEN, REJECTED, IN_PROGRESS, COMPLETE, DNF} This status is begins as OPEN. When a challenger accepts the challenge, this changes to IN_PROGRESS. This will remain IN_PROGRESS until the challenge expires or the challenger wins. It will then be marked COMPLETE. DNF is for future use, for Challenge Matches. |
| created_at | Date/time of object creation. |
| updated_at | Date/time object is updated. |

## Endpoints
There is a standard CRUD endpoint for challenges, and custom endpoints for invite and score actions.

### `GET /api/challenge/`

For a given user token, list all available challenges visible to the user, including complete, in progress, and open.

Parameters:

| Parameter | Description |
| :--- | :--- |
| creator | boolean, only lists challenges where the requesting user is the creator |
| is_archived | boolean, default false: allow listing archived challenges when true |
| is_pro | boolean, default false: list only pro challenges |
| is_premeditated | boolean, default false: list only Challenge Matches |
| is_public | boolean, default true: list only publicly viewable challenges |
| description | string: only returns challenges with a matching description string (future use) |
| machine_name | string: only returns challenges with a matching machine title |
| venuemachine_machine_name | string: only returns challenges with a matching venuemachine machine name |
| venuemachine_venue_name | string: only returns challenges with a matching venue name |
| is_settled | boolean, default n/a: When set to true, only shows settled (complete) challenges, and vice versa |
| invited_user | integer: Return challenges where the invited user matches this userID. Default is authenticated user. |
| included_score | integer: Return challenges with scoreIDs matching this scoreID. |
| expired | boolean: Default true. When false, do not show expired and not incomplete challenges. Recommend setting to false! |
| no_invites | boolean: Show challenges missing invites. Internal use. |
| search | string: Show challenges matching a string. Searches username, cached display name, machine title, venue. |
| ordering | string: "created" is oldest to newest, "-created" is newest to oldest. |
| limit | integer: number of challenges to return per page of response. |
| offset | integer: offset to response count number for querying other pages |

Response:

| Value | Description |
| :--- | :--- |
| count | number of challenges in the response |
| next | id of next challenge |
| previous | id of previous challenge |
| id | integer: id of challenge |
| expiration | string($date-time) |
| Attempts | integer: number of attempts made against the challenge |
| challenge_scores | list of scoreIDs associated with this challenge with all accompanying information |
| challenge_invites | list of userIDs, status (open, in_progress, complete, rejected, dnf), and scores for each invited user | 
| creator_score	| scoreID and accompanying information for given creator's score |
| top_score | current top scoreID and accompanying information for the current top score in the challenge |

### `POST /api/challenge`

Create a new challengeID. Response will include the challengeID. Any of the above model fields can be submitted as part of the challenge json object. Fields may include:

| | Description |
| :--- | :--- |
| creator | integer: ID of user creating the challenge. Defaults to authenticated user. |
| description | Char field, max length 256. (Optional) |
| machine | integer: FK to machineID associated with the challenge. |
| venuemachine | integer: FK to the venuemachine on which the creator scored the challenge |
| expiration | integer: number of days before it expires, default 7 |
| challenge_invites | {userid, status} invited users and status (should be only one). Status can be open, in_progress, complete, rejected, dnf |
| challenge_scores | used to update any scoreIDs associated with the challenge |

All POSTs to create a challengeID must include the creator score information as follows:

| | Description |
| :--- | :--- |
| id | scoreID of creator's score |
| venuemachine | venuemachineID of machine being played on |
| player | userID of creator, default to authenticated user |
| image | url of uploaded image if added. |
| is_verified | set to false if manual submission. Currently not available. |
| initial_score | integer of initial creator's score |
| users_to_invite | array of integers represented invited userIDs. Should be a single user for current challenges. |

### `GET /api/challenge/{id}`

Pull all data related to a specific challengeID. There are no parameters besides {id}.

### `DELETE /api/challenge/{id}`

Sets is_archived=true for given challengeID.

### `/api/challenge/{id}/accept/`

Accepts a challengeID for the authenticated user.

### `POST /api/challenge/<id>/invite/`
### `POST /api/challenge/<id>/uninvite/`

Used to invite new users and remove existing invites. {"user": <id of user>}

### `POST /api/challenge/<id>/reject/`

Used for invited users to reject a challenge or forfeit, only works if the challenge is OPEN. This will transition the ChallengeInvite.status to REJECTED.

### `POST /api/challenge/<id>/submit_score/`

Used to submit scores for a challenge in form of {"score": <id of score to submit>}. This will not accept scores that are old ( > expiration date). This is to be used when a session begins, because the live score is associated with the challenge during the session. When completed scores are submitted the ChallengeInvite.status is transitioned to COMPLETE.

## Example Response Formats
Here is the response format for the Challenge object from the CRUD endpoints:
```
{
  "id": 7,
  "creator": {
    "id": 4,
    "cached_display_name": "Admin",
    "display_name": "Admin",
    "initials": "ADM",
    "is_operator": false,
    "profile_picture": "http://localhost:8000/api/challenge/7/profile_pictures/a15e566f-633c-4343-8737-f161485d2daa.png",
    "username": "admin",
    "first_name": "Admin",
    "last_name": "User",
    "follower_count": 1,
    "following_count": 2,
    "is_my_follower": false,
    "is_my_leader": false
  },
  "description": "Some challenge name here",
  "is_archived": false,
  "is_public": true,
  "is_pro": false,
  "is_premeditated": false,
  "is_venuemachine_specific": false,
  "is_settled": true,
  "machine": 3,
  "venuemachine": null,
  "created": "2020-07-08T23:15:49.481321-07:00",
  "updated": "2020-07-10T11:39:55.517573-07:00",
  "challenge_scores": [
    {
      "score": {
        "id": 54,
        "venuemachine": 3,
        "player": {
          "id": 4,
          "cached_display_name": "Admin",
          "display_name": "Admin",
          "initials": "ADM",
          "is_operator": false,
          "profile_picture": "http://localhost:8000/api/challenge/7/profile_pictures/a15e566f-633c-4343-8737-f161485d2daa.png",
          "username": "admin",
          "first_name": "Admin",
          "last_name": "User",
          "follower_count": 1,
          "following_count": 2,
          "is_my_follower": false,
          "is_my_leader": false
        },
        "image": null,
        "score": 2000,
        "position": 1,
        "is_shared": false,
        "is_verified": true
      },
      "created": "2020-07-09T15:27:47.344758-07:00"
    },
    {
      "score": {
        "id": 41,
        "venuemachine": 3,
        "player": {
          "id": 6,
          "cached_display_name": "Ethan",
          "display_name": "Ethan",
          "initials": "",
          "is_operator": true,
          "profile_picture": null,
          "username": "ethan",
          "first_name": "Ethan",
          "last_name": "Leland",
          "follower_count": 3,
          "following_count": 5,
          "is_my_follower": false,
          "is_my_leader": true
        },
        "image": {
          "id": 30,
          "score": 41,
          "uploader": 4,
          "image": "http://localhost:8000/api/challenge/7/score_images/3/127aeb41-430d-491c-82d4-b963072c9579/1.png",
          "created": "2020-07-07T14:25:35.390394-07:00",
          "updated": "2020-07-07T14:25:35.390410-07:00"
        },
        "score": 1234567,
        "position": 1,
        "is_shared": true,
        "is_verified": false
      },
      "created": "2020-07-10T11:39:49.047226-07:00"
    }
  ],
  "challenge_invites": [
    {
      "user": {
        "id": 4,
        "cached_display_name": "Admin",
        "display_name": "Admin",
        "initials": "ADM",
        "is_operator": false,
        "profile_picture": "http://localhost:8000/api/challenge/7/profile_pictures/a15e566f-633c-4343-8737-f161485d2daa.png",
        "username": "admin",
        "first_name": "Admin",
        "last_name": "User",
        "follower_count": 1,
        "following_count": 2,
        "is_my_follower": false,
        "is_my_leader": false
      },
      "status": "complete",
      "challenge_score": {
        "score": {
          "id": 54,
          "venuemachine": 3,
          "player": {
            "id": 4,
            "cached_display_name": "Admin",
            "display_name": "Admin",
            "initials": "ADM",
            "is_operator": false,
            "profile_picture": "http://localhost:8000/api/challenge/7/profile_pictures/a15e566f-633c-4343-8737-f161485d2daa.png",
            "username": "admin",
            "first_name": "Admin",
            "last_name": "User",
            "follower_count": 1,
            "following_count": 2,
            "is_my_follower": false,
            "is_my_leader": false
          },
          "image": null,
          "score": 2000,
          "position": 1,
          "is_shared": false,
          "is_verified": true
        },
        "created": "2020-07-09T15:27:47.344758-07:00"
      }
    },
    {
      "user": {
        "id": 6,
        "cached_display_name": "Ethan",
        "display_name": "Ethan",
        "initials": "",
        "is_operator": true,
        "profile_picture": null,
        "username": "ethan",
        "first_name": "Ethan",
        "last_name": "Leland",
        "follower_count": 3,
        "following_count": 5,
        "is_my_follower": false,
        "is_my_leader": true
      },
      "status": "complete",
      "challenge_score": {
        "score": {
          "id": 41,
          "venuemachine": 3,
          "player": {
            "id": 6,
            "cached_display_name": "Ethan",
            "display_name": "Ethan",
            "initials": "",
            "is_operator": true,
            "profile_picture": null,
            "username": "ethan",
            "first_name": "Ethan",
            "last_name": "Leland",
            "follower_count": 3,
            "following_count": 5,
            "is_my_follower": false,
            "is_my_leader": true
          },
          "image": {
            "id": 30,
            "score": 41,
            "uploader": 4,
            "image": "http://localhost:8000/api/challenge/7/score_images/3/127aeb41-430d-491c-82d4-b963072c9579/1.png",
            "created": "2020-07-07T14:25:35.390394-07:00",
            "updated": "2020-07-07T14:25:35.390410-07:00"
          },
          "score": 1234567,
          "position": 1,
          "is_shared": true,
          "is_verified": false
        },
        "created": "2020-07-10T11:39:49.047226-07:00"
      }
    }
  ],
  "creator_score": {
    "id": 54,
    "venuemachine": 3,
    "player": {
      "id": 4,
      "cached_display_name": "Admin",
      "display_name": "Admin",
      "initials": "ADM",
      "is_operator": false,
      "profile_picture": "http://localhost:8000/api/challenge/7/profile_pictures/a15e566f-633c-4343-8737-f161485d2daa.png",
      "username": "admin",
      "first_name": "Admin",
      "last_name": "User",
      "follower_count": 1,
      "following_count": 2,
      "is_my_follower": false,
      "is_my_leader": false
    },
    "image": null,
    "score": 2000,
    "position": 1,
    "is_shared": false,
    "is_verified": true
  },
  "top_score": {
    "id": 41,
    "venuemachine": 3,
    "player": {
      "id": 6,
      "cached_display_name": "Ethan",
      "display_name": "Ethan",
      "initials": "",
      "is_operator": true,
      "profile_picture": null,
      "username": "ethan",
      "first_name": "Ethan",
      "last_name": "Leland",
      "follower_count": 3,
      "following_count": 5,
      "is_my_follower": false,
      "is_my_leader": true
    },
    "image": {
      "id": 30,
      "score": 41,
      "uploader": 4,
      "image": "http://localhost:8000/api/challenge/7/score_images/3/127aeb41-430d-491c-82d4-b963072c9579/1.png",
      "created": "2020-07-07T14:25:35.390394-07:00",
      "updated": "2020-07-07T14:25:35.390410-07:00"
    },
    "score": 1234567,
    "position": 1,
    "is_shared": true,
    "is_verified": false
  }
}
```